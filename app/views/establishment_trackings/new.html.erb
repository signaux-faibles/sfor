<%= form_with(model: [@establishment, @establishment_tracking], local: true) do |form| %>

  <div class="fr-container">
    <h1>Nouvel accompagnement pour <%= @establishment_tracking&.establishment&.raison_sociale %></h1>

    <div class="fr-grid-row fr-grid-row--left fr-mb-3w" style="border: grey 1px solid">
      <div class="fr-col-6">

        <div class="fr-p-3w">
          <h2>Contributeurs de l'accompagnement</h2>

          <div class="fr-input-group">
            <%= form.label 'Référents' %>
            <%= form.collection_select :referent_ids, User.all, :id, :full_name, {}, { multiple: true, class: 'tom-select', data: { controller: "tom-select", min_search: "3" } } %>
            <% @establishment_tracking.errors[:referents].each do |error| %>
              <p class="fr-error-text"><%= error %></p>
            <% end %>
          </div>

          <div class="fr-input-group">
            <%= form.label :Participants %>
            <%= form.collection_select :participant_ids, User.all, :id, :full_name, {}, { multiple: true, class: 'tom-select', data: { controller: "tom-select", min_search: "3" } } %>
            <% @establishment_tracking.errors[:participants].each do |error| %>
              <p class="fr-error-text"><%= error %></p>
            <% end %>
          </div>
        </div>
      </div>
    </div>


    <div class="fr-grid-row fr-grid-row--left fr-mb-3w" style="border: grey 1px solid">
      <div class="fr-col-6">

        <div class="fr-p-3w">
          <h2>Informations sur l'accompagnement</h2>

          <div class="fr-input-group <%= 'fr-input-group--error' if @establishment_tracking.errors[:criticality_id].any? %>">
            <%= form.label :criticality_id, 'Criticité' %>
            <%= form.collection_select :criticality_id, 
                Criticality.all, 
                :id, 
                :name, 
                { selected: Criticality.find_by(name: "Pas de criticité")&.id }, 
                { class: 'fr-select' } %>
            <% @establishment_tracking.errors[:criticality_id].each do |error| %>
              <p class="fr-error-text"><%= error %></p>
            <% end %>
          </div>

          <div class="fr-input-group <%= 'fr-input-group--error' if @establishment_tracking.errors[:tracking_label_ids].any? %>">
            <%= form.label :tracking_label_ids, 'Étiquettes' %>
            <%= form.select :tracking_label_ids,
                            @system_labels,
                            {},
                            { multiple: true, class: 'tom-select', placeholder: 'Non renseigné', data: { controller: "tom-select" } } %>
            <% @establishment_tracking.errors[:tracking_label_ids].each do |error| %>
              <p class="fr-error-text"><%= error %></p>
            <% end %>
          </div>

          <div class="fr-input-group <%= 'fr-input-group--error' if @establishment_tracking.errors[:supporting_service_ids].any? %>">
            <%= form.label :supporting_service_ids, 'Suivi par' %>
            <%= form.collection_select :supporting_service_ids, SupportingService.all, :id, :name, {}, { multiple: true, class: 'tom-select', placeholder: 'Non renseigné', data: { controller: "tom-select" } } %>
            <% @establishment_tracking.errors[:supporting_service_ids].each do |error| %>
              <p class="fr-error-text"><%= error %></p>
            <% end %>
          </div>

          <div class="fr-input-group <%= 'fr-input-group--error' if @establishment_tracking.errors[:difficulty_ids].any? %>">
            <%= form.label :Difficultés %>
            <%= form.collection_select :difficulty_ids, Difficulty.all, :id, :name, {}, { multiple: true, class: 'tom-select', placeholder: 'Non renseigné', data: { controller: "tom-select" } } %>
            <% @establishment_tracking.errors[:difficulty_ids].each do |error| %>
              <p class="fr-error-text"><%= error %></p>
            <% end %>
          </div>

          <div class="fr-input-group <%= 'fr-input-group--error' if @establishment_tracking.errors[:user_action_ids].any? %>">
            <%= form.label :user_action_ids, 'Actions réalisées' %>
            <%= form.collection_select :user_action_ids, UserAction.ordered, :id, :name, {}, { multiple: true, class: 'tom-select', placeholder: 'Non renseigné', data: { controller: "tom-select", tom_select_options: { sortField: { field: "position", direction: "asc" } } } } %>
            <% @establishment_tracking.errors[:user_action_ids].each do |error| %>
              <p class="fr-error-text"><%= error %></p>
            <% end %>
          </div>

          <div class="fr-input-group <%= 'fr-input-group--error' if @establishment_tracking.errors[:codefi_redirect_ids].any? %>">
            <%= form.label :codefi_redirect_ids, 'Réorientation hors CODEFI' %>
            <%= form.collection_select :codefi_redirect_ids, CodefiRedirect.ordered, :id, :name, {}, { multiple: true, class: 'tom-select', placeholder: 'Non renseigné', data: { controller: "tom-select" } } %>
            <% @establishment_tracking.errors[:codefi_redirect_ids].each do |error| %>
              <p class="fr-error-text"><%= error %></p>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <div class="fr-grid-row fr-grid-row--left fr-mb-3w" style="border: grey 1px solid">
      <div class="fr-col-6">
        <div class="fr-p-3w">

          <h2>Informations sur l'établissement</h2>
          <p class="fr-m-0"><strong>SIRET</strong></p>

          <p><%= @establishment_tracking.establishment.siret %></p>

          <div class="fr-input-group <%= 'fr-input-group--error' if @establishment_tracking.errors[:size_id].any? %>">
            <%= form.label :size_id, 'Taille de l\'entreprise' %>
            <%= form.collection_select :size_id, Size.all, :id, :name, { include_blank: "Sélectionner une taille" }, { class: 'fr-select' } %>
            <% @establishment_tracking.errors[:size_id].each do |error| %>
              <p class="fr-error-text"><%= error %></p>
            <% end %>
          </div>

          <div class="fr-input-group <%= 'fr-input-group--error' if @establishment_tracking.errors[:sector_ids].any? %>">
            <%= form.label :sector_ids, 'Filières' %>
            <%= form.collection_select :sector_ids, Sector.all, :id, :name, {}, { multiple: true, class: 'tom-select', placeholder: 'Non renseigné', data: { controller: "tom-select" } } %>
            <% @establishment_tracking.errors[:sector_ids].each do |error| %>
              <p class="fr-error-text"><%= error %></p>
            <% end %>
          </div>
        </div>
      </div>
    </div>
    <div class="fr-grid-row fr-grid-row--left fr-mb-3w">
      <div class="fr-col-6">
        <div class="">
          <ul class="fr-btns-group fr-btns-group--inline-md">
            <li>
              <%= form.submit "Créer l'accompagnement", class: 'fr-btn' %>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
<% end %>


