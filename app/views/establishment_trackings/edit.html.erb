<%= form_with(model: [@establishment, @establishment_tracking], local: true, data: { controller: "tracking-status" }) do |form| %>

  <div class="fr-container">
    <div class="fr-alert fr-alert--warning fr-mb-3w fr-hidden" data-tracking-status-target="warningBanner">
      <p>Attention, vous allez rouvrir un accompagnement terminé. Il convient de créer un nouvel accompagnement pour préserver l'historique des accompagnements.</p>
    </div>

    <h1>Modifier les informations - <%= @establishment_tracking&.establishment&.raison_sociale %></h1>

    <div class="fr-grid-row fr-grid-row--left fr-mb-3w" style="border: grey 1px solid">
      <div class="fr-col-6">

        <div class="fr-p-3w">
          <h2>Informations sur l'accompagnement</h2>

          <% if policy(@establishment_tracking).manage_state? %>
            <div class="fr-input-group <%= 'fr-input-group--error' if @establishment_tracking.errors[:state].any? %>">
              <%= form.label :state, 'Statut' %>
              <%= form.select :state, 
                            options_for_select([['En cours', 'in_progress'], ['Terminé', 'completed'], ['Sous surveillance', 'under_surveillance']], 
                            @establishment_tracking.state), 
                            {}, 
                            { class: 'fr-select', data: { tracking_status_target: "stateSelect", action: "change->tracking-status#toggleWarningBanner" } } %>
              <% @establishment_tracking.errors[:state].each do |error| %>
                <p class="fr-error-text"><%= error %></p>
              <% end %>
            </div>
          <% else %>
            <%= form.hidden_field :state, value: @establishment_tracking.state %>
          <% end %>

          <div class="fr-input-group <%= 'fr-input-group--error' if @establishment_tracking.errors[:criticality_id].any? %>">
            <%= form.label :criticality_id, 'Criticité' %>
            <%= form.collection_select :criticality_id, 
                Criticality.all, 
                :id, 
                :name, 
                { selected: @establishment_tracking.criticality_id || Criticality.find_by(name: "Pas de criticité")&.id }, 
                { class: 'fr-select' } %>
            <% @establishment_tracking.errors[:criticality_id].each do |error| %>
              <p class="fr-error-text"><%= error %></p>
            <% end %>
          </div>

          <div class="fr-input-group <%= 'fr-input-group--error' if @establishment_tracking.errors[:tracking_label_ids].any? %>">
            <%= form.label :tracking_label_ids, 'Étiquettes' %>
            <%= form.select :tracking_label_ids,
                            @system_labels,
                            {},
                            { multiple: true, class: 'tom-select', placeholder: 'Non renseigné', data: { controller: "tom-select" } } %>
            <% @establishment_tracking.errors[:tracking_label_ids].each do |error| %>
              <p class="fr-error-text"><%= error %></p>
            <% end %>
          </div>

          <div class="fr-input-group <%= 'fr-input-group--error' if @establishment_tracking.errors[:supporting_service_ids].any? %>">
            <%= form.label :supporting_service_ids, 'Suivi par' %>
            <%= form.collection_select :supporting_service_ids, SupportingService.all, :id, :name, {}, { multiple: true, class: 'tom-select', placeholder: 'Non renseigné', data: { controller: "tom-select" } } %>
            <% @establishment_tracking.errors[:supporting_service_ids].each do |error| %>
              <p class="fr-error-text"><%= error %></p>
            <% end %>
          </div>

          <div class="fr-input-group <%= 'fr-input-group--error' if @establishment_tracking.errors[:difficulty_ids].any? %>">
            <%= form.label :Difficultés %>
            <%= form.collection_select :difficulty_ids, Difficulty.all, :id, :name, {}, { multiple: true, class: 'tom-select', placeholder: 'Non renseigné', data: { controller: "tom-select" } } %>
            <% @establishment_tracking.errors[:difficulty_ids].each do |error| %>
              <p class="fr-error-text"><%= error %></p>
            <% end %>
          </div>

          <div class="fr-input-group <%= 'fr-input-group--error' if @establishment_tracking.errors[:user_action_ids].any? %>">
            <%= form.label :user_action_ids, 'Actions réalisées' %>
            <%= form.collection_select :user_action_ids, UserAction.ordered, :id, :name, {}, { multiple: true, class: 'tom-select', placeholder: 'Non renseigné', data: { controller: "tom-select", tom_select_options: { sortField: { field: "position", direction: "asc" } } } } %>
            <% @establishment_tracking.errors[:user_action_ids].each do |error| %>
              <p class="fr-error-text"><%= error %></p>
            <% end %>
          </div>

          <div class="fr-input-group <%= 'fr-input-group--error' if @establishment_tracking.errors[:codefi_redirect_ids].any? %>">
            <%= form.label :codefi_redirect_ids, 'Réorientation hors CODEFI' %>
            <%= form.collection_select :codefi_redirect_ids, CodefiRedirect.ordered, :id, :name, {}, { multiple: true, class: 'tom-select', placeholder: 'Non renseigné', data: { controller: "tom-select" } } %>
            <% @establishment_tracking.errors[:codefi_redirect_ids].each do |error| %>
              <p class="fr-error-text"><%= error %></p>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <div class="fr-grid-row fr-grid-row--left fr-mb-3w" style="border: grey 1px solid">
      <div class="fr-col-6">
        <div class="fr-p-3w">

          <h2>Informations sur l'établissement</h2>
          <p class="fr-m-0"><strong>SIRET</strong></p>

          <p><%= @establishment_tracking.establishment.siret %></p>

          <div class="fr-input-group <%= 'fr-input-group--error' if @establishment_tracking.errors[:size_id].any? %>">
            <%= form.label :size_id, 'Taille de l\'entreprise' %>
            <%= form.collection_select :size_id, Size.all, :id, :name, { include_blank: "Non renseigné" }, { class: 'fr-select' } %>
            <% @establishment_tracking.errors[:size_id].each do |error| %>
              <p class="fr-error-text"><%= error %></p>
            <% end %>
          </div>

          <div class="fr-input-group <%= 'fr-input-group--error' if @establishment_tracking.errors[:sector_ids].any? %>">
            <%= form.label :sector_ids, 'Filières' %>
            <%= form.collection_select :sector_ids, Sector.all, :id, :name, {}, { multiple: true, class: 'tom-select', placeholder: 'Non renseigné', data: { controller: "tom-select" } } %>
            <% @establishment_tracking.errors[:sector_ids].each do |error| %>
              <p class="fr-error-text"><%= error %></p>
            <% end %>
          </div>
        </div>
      </div>
    </div>
    <div class="fr-grid-row fr-grid-row--left fr-mb-3w">
      <div class="fr-col-6">
        <div class="">
          <ul class="fr-btns-group fr-btns-group--inline-md">
            <li>
              <%= link_to 'Annuler', establishment_establishment_tracking_path(@establishment, @establishment_tracking), class: 'fr-btn fr-btn--secondary' %>
            </li>
            <li>
              <%= form.submit 'Enregistrer les modifications', class: 'fr-btn' %>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
<% end %>


