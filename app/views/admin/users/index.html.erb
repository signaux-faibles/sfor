<div class="fr-mb-3w">
  <h1 class="fr-h1 fr-mb-2w">Gestion des utilisateurs</h1>
  
  <!-- Search Form -->
  <%= form_with url: admin_users_path, method: :get, local: true, class: "fr-mb-2w" do |form| %>
    <div style="max-width: 400px;">
      <div class="fr-search-bar" role="search">
        <label class="fr-label" for="search-input">
          Rechercher
        </label>
        <%= form.search_field :search, 
            value: params[:search], 
            placeholder: "Rechercher par email...", 
            class: "fr-input",
            id: "search-input",
            "aria-describedby": "search-input-messages" %>
        <div class="fr-messages-group" id="search-input-messages" aria-live="polite">
        </div>
        <button title="Rechercher" type="submit" class="fr-btn">Rechercher</button>
      </div>
      <% if params[:search].present? %>
        <div class="fr-mt-1w">
          <%= link_to "Effacer la recherche", admin_users_path, class: "fr-btn fr-btn--secondary fr-btn--sm" %>
        </div>
      <% end %>
    </div>
  <% end %>
</div>

<% if params[:search].present? %>
  <div class="fr-alert fr-alert--info fr-mb-2w">
    <p>
      <%= pluralize(@users_count, "utilisateur trouvé", "utilisateurs trouvés") %> 
      pour "<strong><%= params[:search] %></strong>"
    </p>
  </div>
<% end %>

<div class="fr-table">
  <table>
    <thead>
      <tr>
        <th scope="col">Email</th>
        <th scope="col">Nom</th>
        <th scope="col">Segment</th>
        <th scope="col">Dernière connexion</th>
        <th scope="col">Actions</th>
      </tr>
    </thead>
    <tbody>
      <% @users.each do |user| %>
        <tr>
          <td><%= user.email %></td>
          <td><%= user.display_name %></td>
          <td>
            <% if user.segment&.name %>
              <span class="fr-badge fr-badge--sm <%= 'fr-badge--success' if user.segment.name == 'sf' %>">
                <%= user.segment.name %>
              </span>
            <% else %>
              <span class="fr-badge fr-badge--sm">Aucun</span>
            <% end %>
          </td>
          <td>
            <%= user.last_sign_in_at ? l(user.last_sign_in_at, format: :short) : "Jamais" %>
          </td>
          <td>
            <%= link_to "Imiter", 
                [:impersonate, :admin, user], 
                method: :get,
                class: "fr-btn fr-btn--sm",
                data: { 
                  confirm: "Êtes-vous sûr de vouloir vous connecter en tant que #{user.email} ?" 
                } %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<% if @users.respond_to?(:current_page) %>
  <div class="fr-mt-2w">
    <%= paginate @users %>
  </div>
<% end %>